local index = 0
local hasdebuff = 0
local debuffcount = 0
local auraID1 = 194384
local auraID2 = 114255 --圣光涌动

local debuffs = {
    "虚空裂隙", "暗影烈焰笼罩", "暮光烈焰", "熵能诅咒", "深渊腐蚀",
    "虚空感染", "结晶喷发", "不稳定的爆炸", "虚空腐蚀",
    "过度生长", "排斥", "不稳定的酸液", "钉刺突袭",
    "虚空奔袭", "贪婪之虫", "腐化附层", "捻接",
    "暗影之幕", "折磨光束", "迸发虫茧", "诱捕暗影",
    "艾泽里特炸药", "腐败之水",
}
-- 获取技能冷却时间的函数
local function getCooldown(spellID)
    local cooldown = C_Spell.GetSpellCooldown(spellID)
    return (cooldown.startTime > 0) and (cooldown.startTime + cooldown.duration - GetTime()) or 0
end
--获取技能充能层数的函数
local function getCharges(spellID)
    local charges = C_Spell.GetSpellCharges(spellID)
    return charges and charges.currentCharges or 0 -- 如果没有充能信息,则返回 0
end

--获取单位有害光环的函数
local function hasDebuff(unit)
    for _, debuff in ipairs(debuffs) do
        for i = 1, 40 do
            local debuffData = C_UnitAuras.GetAuraDataByIndex(unit, i, "HARMFUL")
            if not debuffData then break end
            if debuffData.name == debuff then
                return true
            end
        end
    end
    return false
end
--获取单位有益光环的函数
local function hasAura(unit, auraID)
    for j = 1, 40 do
        local auraData = C_UnitAuras.GetAuraDataByIndex(unit, j, "HELPFUL")
        if not auraData then break end
        if auraData.spellId == auraID then
            return true
        end
    end
    return false
end

-- 检查技能冷却
local GCD = getCooldown(61304)     -- 公共冷却
local Shield = getCooldown(17)     -- 真言术：盾
local Penance = getCooldown(47540) -- 苦修
local Rapture = getCooldown(47536) -- 全神贯注
-- 检测技能充能
local Shine = getCharges(194509)   --真言术：耀


if not UnitPlayerOrPetInRaid("player") then
    if hasDebuff("player") and not hasAura("player") then
        debuffcount = debuffcount + 1
        hasdebuff = 1
    end

    -- 检查小队成员的减益情况
    for i = 1, 4 do
        local unit = "party" .. i
        if UnitExists(unit) and not UnitIsDeadOrGhost(unit) then
            local hasAura1 = hasAura(unit, auraID1) --救赎
            local hasAura2 = hasAura(unit, auraID2) --圣光涌动
            if hasDebuff(unit) and not hasAura1 then
                debuffcount = debuffcount + 1
                hasdebuff = i + 1
            end
        end
    end
end

-- 设置 index 值
if debuffcount >= 2 then
    index = 50
else
    index = hasdebuff
end

return index
