local index = 0
local auraID1 = 774 -- 光环回春术
local auraID2 = 155777 -- 光环回春术（萌芽）
local auraName = "救赎之魂"
local healthThreshold90 = 90
local healthThreshold80 = 80

-- 检查技能冷却
local G = C_Spell.GetSpellCooldown(61304)-- 公共冷却
local GCD = (G.startTime > 0) and (G.startTime + G.duration - GetTime()) or 0

local Flourish = C_Spell.GetSpellCooldown(48438)-- 野性成长
local FlourishCD = (Flourish.startTime > 0) and (Flourish.startTime + Flourish.duration - GetTime()) or 0

-- 检测技能充能
local Swiftmend = C_Spell.GetSpellCharges(18562)-- 迅捷治疗
local SwiftmendCharges = Swiftmend.currentCharges

local Grove = C_Spell.GetSpellCharges(102693)-- 树人
local GroveCharges = Grove.currentCharges

-- 检查光环
local function hasAura(unit, auraID)
    for j = 1, 40 do
        local auraData = C_UnitAuras.GetAuraDataByIndex(unit, j, "HELPFUL")
        if not auraData then break end
        if (auraData.spellId == auraID and auraData.sourceUnit == "player") or (auraData.name == auraName) then
            return true
        end
    end
    return false
end

local teammateCount = 0
local ninetyCount = 0
local eightyCount = 0
local setCount = 0

if UnitPlayerOrPetInRaid("player") then
    for i = 1, 40 do
        local unit = "raid" .. i
        if UnitExists(unit) and not UnitIsDeadOrGhost(unit) and UnitCanAssist("player", unit) and UnitInRange(unit) then
            teammateCount = teammateCount + 1
            local unitHealth = UnitHealth(unit) / UnitHealthMax(unit) * 100
            local hasAura1 = hasAura(unit, auraID1)
            local hasAura2 = hasAura(unit, auraID2)
            
            if teammateCount > 1 and teammateCount <= 5 then
                setCount = 2
            elseif teammateCount <= 10 then
                setCount = 3
            elseif teammateCount <= 15 then
                setCount = 4
            else
                setCount = 5
            end
            
            -- 统计低于设定值生命值的单位数量
            if unitHealth < healthThreshold90 then
                ninetyCount = ninetyCount + 1
            end
            if unitHealth < healthThreshold80 then
                eightyCount = eightyCount + 1
            end
            
            -- 如果低血量单位超过setCount个且树人充能充足
            if eightyCount >= setCount and GroveCharges >= 2 then
                index = 50
            end
            
            if ninetyCount >= setCount then
                if GroveCharges >= 3 then
                    index = 50 -- 放树人
                elseif FlourishCD <= GCD then
                    index = 51 -- 放成长
                end
            end
            
            -- 判断单位生命值和光环条件
            if ninetyCount < setCount or (FlourishCD > GCD) or GroveCharges < 3 then
                if unitHealth < healthThreshold90 then
                    if not hasAura1 and not hasAura2 then
                        index = i + 5
                    elseif hasAura1 or hasAura2 then
                        index = 0
                    end
                end
                
                if unitHealth < healthThreshold80 then
                    if hasAura1 ~= hasAura2 then
                        index = i + 5
                    elseif hasAura1 and hasAura2 then
                        index = 0
                    end
                end
            end
        end
    end
end

return index