local index = 0 --输出指令，50代表耀
local lowestHealth = 100
local auraName1 = "救赎"
local auraName2 = "恢复"
local auraName3 = "真言术：韧"
local SpiritofRedemption = "救赎之魂"
local playerHealth = UnitHealth("player") / UnitHealthMax("player") * 100

-- 检查技能冷却
local G = C_Spell.GetSpellCooldown(61304) -- 公共冷却
local GCD = (G.startTime > 0) and (G.startTime + G.duration - GetTime()) or 0

local Shield = C_Spell.GetSpellCooldown(17) -- 真言术：盾
local ShieldCD = (Shield.startTime > 0) and (Shield.startTime + Shield.duration - GetTime()) or 0

local Penance = C_Spell.GetSpellCooldown(47540) -- 苦修
local PenanceCD = (Penance.startTime > 0) and (Penance.startTime + Penance.duration - GetTime()) or 0

local Rapture = C_Spell.GetSpellCooldown(47536) --  全神贯注
local RaptureCD = (Rapture.startTime > 0) and (Rapture.startTime + Rapture.duration - GetTime()) or 0

-- 检测技能充能
local Shine = C_Spell.GetSpellCharges(18562) -- 真言术：耀
local ShineCharges = Shine.currentCharges

local function hasAura(unit, auraName)
    for j = 1, 40 do
        local auraData = C_UnitAuras.GetAuraDataByIndex(unit, j, "HELPFUL")
        if not auraData then break end
        if (auraData.name == auraName and auraData.sourceUnit == "player") or
            (auraData.name == SpiritofRedemption) then
            return true
        end
    end
    return false
end

local teammateCount = 0
local RenewCount = 0
local ninetyCount = 0
local setCount = 0
local noRedemptionCount = 0

if UnitPlayerOrPetInRaid("player") then
    for i = 1, 40 do
        local unit = "raid" .. i
        if UnitExists(unit) and not UnitIsDeadOrGhost(unit) and UnitCanAssist("player", unit) and UnitInRange(unit) then
            teammateCount = teammateCount + 1
            local unitHealth = UnitHealth(unit) / UnitHealthMax(unit) * 100
            local hasAura1 = hasAura(unit, auraName1)
            local hasAura2 = hasAura(unit, auraName2)
            local hasAura3 = hasAura(unit, auraName3)

            if teammateCount > 1 and teammateCount <= 5 then
                setCount = 2
            elseif teammateCount <= 10 then
                setCount = 3
            elseif teammateCount <= 15 then
                setCount = 4
            else
                setCount = 5
            end

            if not hasAura1 and unitHealth < 90 then --无救赎单位数量
                noRedemptionCount = noRedemptionCount + 1
            end

            -- 如果无救赎生命值低于95%的单位超过setCount个且耀充能充足
            if noRedemptionCount >= setCount and ShineCharges >= 1 then
                index = 50
            end

            if hasAura2 then --统计恢复数量
                RenewCount = RenewCount + 1
            end

            if not hasAura1 then
                if unitHealth < lowestHealth then
                    lowestHealth = unitHealth
                    index = i + 5
                end
            end
        end
    end
elseif UnitPlayerOrPetInParty("player") then
    for i = 1, 4 do
        local unit = "party" .. i
        if UnitExists(unit) and not UnitIsDeadOrGhost(unit) and UnitCanAssist("player", unit) and UnitInRange(unit) then
            if not hasAura(unit, auraName1) then
                local unitHealth = UnitHealth(unit) / UnitHealthMax(unit) * 100
                if unitHealth < lowestHealth then
                    lowestHealth = unitHealth
                    index = i + 1
                end
            end
        end
    end
    if not hasAura("player", auraName1) and playerHealth < lowestHealth then
        index = 1
    end
end

return index
