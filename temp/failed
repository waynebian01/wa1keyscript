local moonCountdown = 30
local sunCountdown = 30
local isMoonTimerRunning = false
local isSunTimerRunning = false

local function decreaseMoonCountdown()
   if moonCountdown > 0 then
      moonCountdown = moonCountdown - 1
      Wa1Key.Prop.moonCD = moonCountdown
      print("Moon Countdown: " .. moonCountdown)
      C_Timer.After(1, decreaseMoonCountdown) -- 1秒后调用 decreaseMoonCountdown 函数
   else
      Wa1Key.Prop.moonCD = nil
      print("Moon Countdown finished!")
      isMoonTimerRunning = false
   end
end

local function decreaseSunCountdown()
   if sunCountdown > 0 then
      sunCountdown = sunCountdown - 1
      Wa1Key.Prop.sunCD = sunCountdown
      print("Sun Countdown: " .. sunCountdown)
      C_Timer.After(1, decreaseSunCountdown) -- 1秒后调用 decreaseSunCountdown 函数
   else
      Wa1Key.Prop.sunCD = nil
      print("Sun Countdown finished!")
      isSunTimerRunning = false
   end
end

local function startMoonTimer()
   if not isMoonTimerRunning then
      moonCountdown = 30
      Wa1Key.Prop.moonCD = moonCountdown
      print("Moon Countdown: " .. moonCountdown)
      isMoonTimerRunning = true
      C_Timer.After(1, decreaseMoonCountdown) -- 1秒后开始减少倒计时
   end
end

local function startSunTimer()
   if not isSunTimerRunning then
      sunCountdown = 30
      Wa1Key.Prop.sunCD = sunCountdown
      print("Sun Countdown: " .. sunCountdown)
      isSunTimerRunning = true
      C_Timer.After(1, decreaseSunCountdown) -- 1秒后开始减少倒计时
   end
end

local frame = CreateFrame("Frame")

frame:RegisterEvent("UNIT_AURA")
frame:SetScript("OnEvent", function(self, event, arg1)
      if arg1 == "player" then
         for i = 1, 40 do
            local name, , , , , , , , _, spellId = UnitBuff("player", i)
            if spellId == 48518 then
               startMoonTimer()
            elseif spellId == 48517 then
               startSunTimer()
            end
         end
      end
end)